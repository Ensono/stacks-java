# Plan: Eirctl Implementation for Stacks-Java (Detailed)

Implement eirctl task automation for the stacks-java project while preserving all existing quality gates, tests, and deployment pipeline structure. The migration will replace shell scripts with eirctl task variations, chain java/api-tests projects with dependencies, and maintain compatibility with external Ensono pipeline templates.

## Objective

- Migrate existing Azure DevOps pipeline steps from shell scripts and custom templates to eirctl tasks
- Ensure all current build, test, quality gate, and deployment functionality is preserved
- Leverage containerized contexts for consistent build environments
- Create reusable tasks for common operations (build, test, format, security scan, sonar analysis
- Validate eirctl implementation locally and in CI before full replacement

## Tracking

Ensure that this plan is tracked in [the tracker](../eirctl-implementation-checklist.md) and review this for progress against the steps below before starting any work. Once work has been completed and verified mark the relevant items in the checklist as done.

## Steps

1. **Align with stacks-pipeline-templates main** by updating the pipeline repository reference in [azure-pipelines-javaspring-k8s.yml](build/azDevOps/azure/azure-pipelines-javaspring-k8s.yml) from `ref: feature/cycle4` to `ref: main` once verified. Note: the `templates/steps/build/*.yml` wrappers used in cycle4 (e.g., `build-java.yml`, `build-api-tests.yml`, `test-static-code-analysis.yml`) do not exist on `main`; the main branch exposes bash scripts directly under `/scripts`. Map each current template usage to the main-branch scripts, capturing options and defaults: `build-maven-install.bash`, `build-maven-compile.bash`, `test-maven-format-check.bash`, `test-maven-checkstyle-check.bash`, `test-maven-spotbugs-check.bash`, `test-maven-tagged-test-run.bash`, `test-maven-download-test-deps.bash`, `test-maven-owasp-dependency-check.bash`, `test-sonar-scanner.bash`, `deploy-k8s-envsubst.bash`, `deploy-k8s-apply.bash`, `deploy-k8s-rollout-status.bash`, plus legacy v2 helper scripts under `azDevOps/azure/templates/v2/scripts/` (set-azure-context.sh, set-aks-context.sh, yaml-templating.sh). Extract Maven goals, Surefire/Failsafe parameters, tag filters, cache arguments (`-Z` for maven cache path), optional NVD API key / OSS Index flags, and required env vars so eirctl tasks mirror current behavior.

2. **Create eirctl directory structure and base configuration** by running `mkdir -p build/eirctl`, creating [eirctl.yaml](eirctl.yaml) with imports to `./build/eirctl/contexts.yaml` and `./build/eirctl/tasks.yaml`, adding JSON schema reference `# yaml-language-server: $schema=https://raw.githubusercontent.com/Ensono/eirctl/main/schemas/schema_v1.json` for IDE validation

3. **Define containerized contexts** in [build/eirctl/contexts.yaml](build/eirctl/contexts.yaml) with `buildenv` context using `ensono/eir-java:1.1.251` container matching pipeline, `infrastructure` context using `ensono/eir-infrastructure:1.1.251` for Docker/K8s tasks, configure Maven cache volume mount `-v ${PWD}/.m2:/root/.m2` to match pipeline's `maven_cache_directory`, set `shell: pwsh` and `shell_args: [-Command]` without `-NoProfile`, add `envfile.exclude` for `[home, path, tmpdir]`. Allow an optional override to use a named Docker volume (e.g., `M2_VOLUME=stacks-maven-cache`) for CI agents without workspace persistence.

4. **Create comprehensive task library** in [build/eirctl/tasks.yaml](build/eirctl/tasks.yaml) with java project tasks (`build`, `build-skip-tests`, `test` using `-Dgroups="Unit,Component,Integration"`, `integration-test`, `verify`, `format`, `format-check`, `checkstyle`, `spotbugs`, `pitest`, `security-scan` with `-P owasp-dependency-check`, `sonar` with dynamic properties), api-tests project tasks with `dir: ../api-tests` (`api-build`, `api-test-functional` using `-Dcucumber.filter.tags="@Functional or @Smoke and not @Ignore"`, `api-test-smoke`, `api-test-untagged-check`), and utility tasks (`clean`, `dependency-tree`, `docker-build`, `cache-warm` running `./mvnw dependency:go-offline -Dmaven.repo.local=./.m2 --no-transfer-progress`). Encode template parameter mappings: pass `M2_LOCATION` to all Maven invocations, propagate tag allow/ignore lists, wire OWASP flags (`-W/-X/-Y/-Z`), Sonar PR params, and deploy helpers. Make test thread count configurable via task vars (default 4) and forward to Maven/Serenity (`-Dthreads=${THREADS}`/`-Dserenity.threads=${THREADS}`).

5. **Replace shell scripts with task variations** by creating `run-azure` task with `command: ./mvnw spring-boot:run -Pazure,-aws`, `run-aws` task with `command: ./mvnw spring-boot:run -Paws,-azure`, `run-all-clouds` task with `command: ./mvnw spring-boot:run -Pazure,aws`, `package-azure` with `./mvnw clean package -Dazure.profile.name=azure -Daws.profile.name=no-aws -DskipTests`, `package-aws` with `./mvnw clean package -Daws.profile.name=aws -Dazure.profile.name=no-azure -DskipTests`, eliminating dependency on `xmlstarlet` and non-destructive POM modifications compared to [java/run_scenario.sh](java/run_scenario.sh) and [java/deploy_scenario.sh](java/deploy_scenario.sh)

6. **Build CI/CD pipelines with chained dependencies** by defining `ci-build` pipeline with stages for format check (allow_failure: false), parallel build-azure and build-aws tasks, test stage depending on builds, integration-test stage, security-scan and sonar in parallel depending on tests, then `api-build` depending on java verify, and `api-test-functional` depending on api-build; create `quality-gate` pipeline running format-check, checkstyle, spotbugs, pitest, security-scan in parallel; create `local-dev` pipeline with build-skip-tests → cache-warm → run-azure. Parameterize THREADS (default 4) for api-test tasks and allow lowering in CI if constrained.

7. **Install and validate locally** by downloading eirctl 0.9.7 (`wget https://github.com/Ensono/eirctl/releases/download/0.9.7/eirctl-linux-amd64 -O /tmp/eirctl && chmod +x /tmp/eirctl && sudo mv /tmp/eirctl /usr/local/bin/eirctl`), running `eirctl validate` to check configuration schema, testing individual tasks (`eirctl build`, `eirctl test`, `eirctl format-check`), verifying Maven cache persistence between runs (check `.m2` directory populates), running `eirctl run pipeline ci-build` and comparing outputs with direct Maven execution, checking all reports generate (`target/surefire-reports/`, `target/site/jacoco/`, `api-tests/target/site/serenity/`)

8. **Create Azure DevOps integration** by adding [build/azDevOps/azure/templates/install-eirctl.yml](build/azDevOps/azure/templates/install-eirctl.yml) with Bash@3 task downloading eirctl from GitHub releases, updating [build/azDevOps/azure/azuredevops-vars.yml](build/azDevOps/azure/azuredevops-vars.yml) with `EirctlVersion: 0.9.7`, adding installation step to [azure-pipelines-javaspring-k8s.yml](build/azDevOps/azure/azure-pipelines-javaspring-k8s.yml) before build stage, initially running eirctl tasks in parallel with existing template/script-based builds for validation (e.g., `- script: eirctl build` alongside the current main-branch template or equivalent script call), comparing build artifacts and test reports between both approaches

9. **Replace pipeline templates incrementally** after validation by swapping the cycle4-only template calls with either `eirctl` scripts or direct invocations of the main-branch bash scripts. Example replacements: `templates/steps/build/build-java.yml` → `eirctl build` (or `bash $(self_pipeline_scripts_dir)/build-maven-install.bash ...` with matching parameters), `templates/steps/build/build-api-tests.yml` → `eirctl api-build` (or `test-maven-tagged-test-run.bash` plus artefact packaging), `templates/steps/build/test-static-code-analysis.yml` → `eirctl sonar` plus `test-maven-spotbugs-check.bash`/`test-maven-checkstyle-check.bash`, and the deploy steps → `deploy-k8s-envsubst.bash`, `deploy-k8s-apply.bash`, `deploy-k8s-rollout-status.bash` as needed. Preserve environment variable groups (`azure-sp-creds`, `stacks-acr-creds`, `sonar-credentials`, `stacks-java-owasp-keys`) and container definitions, maintain stage structure (Build → Dev → Prod → Release), and keep Terraform/Kubernetes template usage unchanged.

10. **Document migration and create quality gate validation** by creating checklist verifying fmt-maven-plugin Google Java Style enforcement still blocks builds on format violations, all Surefire/Failsafe reports publish to Azure DevOps Test Results tab, JaCoCo coverage XML uploads to SonarCloud, OWASP scan produces `dependency-check-report.html` in artifacts, PITest generates mutation reports in `target/pit-reports/`, Serenity reports accessible at `api-tests/target/site/serenity/index.html`, Docker image builds and pushes to ACR successfully, updating [README.md](README.md) with eirctl quick start guide replacing references to [java/run_scenario.sh](java/run_scenario.sh), adding troubleshooting section for common eirctl Docker/permission issues
